# Automation
pywinauto、pyautogui 实现的，三国志英杰传自动化脚本，复现极限练级的步骤。用来练习 python 和桌面自动化脚本，作为技能储备。

## 说明

### 目录结构
- `sgzyjz.py` 为工具文件，主要暴露 main 方法用来运行各关的脚本，具体情况见代码；
- `sgzyjz.zip` 为游戏压缩包，已经做了初始化处理，也集成了各种修改器；
- 关卡目录，例如 `0_1` 指序章第一关。里面放了该关卡的自动化脚本和 DOSBox 的存档文件；
- `run.py` 中的 main 函数，主要需要输入武将列表、action 列表，其它参数一看就明白，就不多解释了。

### 必要配置
1. 修改 `dosbox.conf` 中的 `autolock` 为 false；
2. 用补丁将天气锁定为【晴天】；
3. 进入游戏后，修改【设定速度】为普通，否则作战时移动屏幕会很不可控；
4. 进入战斗后，关闭部队战斗、敌军移动，移动速度设为 5；

## 使用
```bash
pip install pyautogui
pip install pywinauto
```
安装必要依赖后，在游戏中进入关卡，运行相应脚本即可，如 `python ./0_1/run.py`。

注意，关卡会有随机因素存在，脚本很可能匹配不上，尤其是最初的几关。所以在目录里还有 DOSBox 的存档文件，可以保证脚本的顺利执行。只需将这些文件复制到游戏根目录，然后 `double ctrl` 换出菜单，读取存档即可。

## 踩到的坑

### DOSBox 里无法操作鼠标
开始的时候，因为 DOSBox 会把鼠标所在自己的窗口里，所以脚本没有办法操作鼠标。

后来发现不锁定鼠标的办法，修改一下 autolock 就可以了，果然可以操作鼠标的移动了。

但是，笔者发现目前只有一个版本的英杰传是可以让鼠标平滑的在 DOSBox 和桌面之间切换的。其他版本都会在切出 DOSBox 的时刻出现坐标偏差，所以就连这个版本的游戏一起打包传上来了，反正也不大。

### DOSBox 中鼠标点击事件无效

控制鼠标移动的问题解决了，结果发现了更大的问题：鼠标点击事件在 DOSBox 中无效。更确切地说，有多次鼠标点击事件，最多只会相应一次，而且不一定是哪一次。

pywinauto、pyautogui、pynput 都用了，甚至还尝试了 nodejs 的 robotjs，但是都解决不了点击事件无效的问题。后来发现 按键精灵 2014 的鼠标点击没什么问题，但是 vbs 的语法实在是太单薄了，严重影响编程感受及效率，于是又返回来研究 robotjs。

结果无意间发现，robotjs 的 click 事件其实是 pressDown + pressUp 实现的，这突然给我了灵感，于是把所有 click 事件都换成了 pressDown + pressUp。果然！点击事件终于可用了，后来又回去试了 python 的那些库，都可以了，终于万事俱备了。

## 参考攻略
https://blog.csdn.net/weixin_29282577/article/details/114233271